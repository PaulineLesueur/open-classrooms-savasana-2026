<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SessionControllerIT.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">starterjwt in yoga-app Coverage Results</a> &gt; <a href="index.source.html" class="el_package">com.openclassrooms.starterjwt.controllers</a> &gt; <span class="el_source">SessionControllerIT.java</span></div><h1>SessionControllerIT.java</h1><pre class="source lang-java linenums">package com.openclassrooms.starterjwt.controllers;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.openclassrooms.starterjwt.dto.SessionDto;
import com.openclassrooms.starterjwt.models.Session;
import com.openclassrooms.starterjwt.models.User;
import com.openclassrooms.starterjwt.repository.SessionRepository;
import com.openclassrooms.starterjwt.repository.UserRepository;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.http.MediaType;
import org.springframework.security.test.context.support.WithMockUser;
import org.springframework.test.web.servlet.MockMvc;
import org.springframework.transaction.annotation.Transactional;

import java.util.ArrayList;
import java.util.Date;

import static org.hamcrest.Matchers.*;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.*;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.*;

@SpringBootTest
@AutoConfigureMockMvc
@Transactional
<span class="fc" id="L29">public class SessionControllerIT {</span>

    @Autowired
    private MockMvc mockMvc;

    @Autowired
    private SessionRepository sessionRepository;

    @Autowired
    private UserRepository userRepository;

    @Autowired
    private ObjectMapper objectMapper;

    private Session session;
    private User user;

    @BeforeEach
    public void setup() {
<span class="fc" id="L48">        sessionRepository.deleteAll();</span>
<span class="fc" id="L49">        userRepository.deleteAll();</span>

<span class="fc" id="L51">        user = createTestUser();</span>
<span class="fc" id="L52">        user = userRepository.save(user);</span>

<span class="fc" id="L54">        session = new Session();</span>
<span class="fc" id="L55">        session.setName(&quot;Session Test&quot;);</span>
<span class="fc" id="L56">        session.setDescription(&quot;Description test&quot;);</span>
<span class="fc" id="L57">        session.setDate(new Date());</span>
<span class="fc" id="L58">        session.setUsers(new ArrayList&lt;&gt;());</span>
<span class="fc" id="L59">        session.getUsers().add(user);</span>
<span class="fc" id="L60">        session = sessionRepository.save(session);</span>
<span class="fc" id="L61">    }</span>

    private User createTestUser() {
<span class="fc" id="L64">        User u = new User();</span>
<span class="fc" id="L65">        u.setFirstName(&quot;Test&quot;);</span>
<span class="fc" id="L66">        u.setLastName(&quot;User&quot;);</span>
<span class="fc" id="L67">        u.setEmail(&quot;testuser@example.com&quot;);</span>
<span class="fc" id="L68">        u.setPassword(&quot;password&quot;);</span>
<span class="fc" id="L69">        u.setAdmin(false);</span>
<span class="fc" id="L70">        return u;</span>
    }

    @Test
    @WithMockUser
    public void testFindAll_ShouldReturnSessions() throws Exception {
<span class="fc" id="L76">        mockMvc.perform(get(&quot;/api/session&quot;))</span>
<span class="fc" id="L77">                .andExpect(status().isOk())</span>
<span class="fc" id="L78">                .andExpect(jsonPath(&quot;$&quot;, hasSize(1)))</span>
<span class="fc" id="L79">                .andExpect(jsonPath(&quot;$[0].name&quot;, is(&quot;Session Test&quot;)));</span>
<span class="fc" id="L80">    }</span>

    @Test
    @WithMockUser
    public void testFindById_ExistingId_ShouldReturnSession() throws Exception {
<span class="fc" id="L85">        mockMvc.perform(get(&quot;/api/session/{id}&quot;, session.getId()))</span>
<span class="fc" id="L86">                .andExpect(status().isOk())</span>
<span class="fc" id="L87">                .andExpect(jsonPath(&quot;$.name&quot;, is(&quot;Session Test&quot;)));</span>
<span class="fc" id="L88">    }</span>

    @Test
    @WithMockUser
    public void testFindById_NonExistingId_ShouldReturn404() throws Exception {
<span class="fc" id="L93">        mockMvc.perform(get(&quot;/api/session/{id}&quot;, 999L))</span>
<span class="fc" id="L94">                .andExpect(status().isNotFound());</span>
<span class="fc" id="L95">    }</span>

    @Test
    @WithMockUser
    public void testFindById_InvalidId_ShouldReturn400() throws Exception {
<span class="fc" id="L100">        mockMvc.perform(get(&quot;/api/session/{id}&quot;, &quot;invalid&quot;))</span>
<span class="fc" id="L101">                .andExpect(status().isBadRequest());</span>
<span class="fc" id="L102">    }</span>

    @Test
    @WithMockUser
    public void testCreate_ValidSession_ShouldReturnCreatedSession() throws Exception {
<span class="fc" id="L107">        SessionDto newSession = new SessionDto();</span>
<span class="fc" id="L108">        newSession.setName(&quot;New Session&quot;);</span>
<span class="fc" id="L109">        newSession.setDescription(&quot;New Description&quot;);</span>
<span class="fc" id="L110">        newSession.setDate(new Date());</span>
<span class="fc" id="L111">        newSession.setTeacher_id(1L);</span>

<span class="fc" id="L113">        mockMvc.perform(post(&quot;/api/session&quot;)</span>
<span class="fc" id="L114">                        .contentType(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L115">                        .content(objectMapper.writeValueAsString(newSession)))</span>
<span class="fc" id="L116">                .andExpect(status().isOk())</span>
<span class="fc" id="L117">                .andExpect(jsonPath(&quot;$.name&quot;, is(&quot;New Session&quot;)))</span>
<span class="fc" id="L118">                .andExpect(jsonPath(&quot;$.description&quot;, is(&quot;New Description&quot;)));</span>
<span class="fc" id="L119">    }</span>

    @Test
    @WithMockUser
    public void testCreate_InvalidSession_ShouldReturn400() throws Exception {
<span class="fc" id="L124">        SessionDto invalidSession = new SessionDto();</span>

<span class="fc" id="L126">        mockMvc.perform(post(&quot;/api/session&quot;)</span>
<span class="fc" id="L127">                        .contentType(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L128">                        .content(objectMapper.writeValueAsString(invalidSession)))</span>
<span class="fc" id="L129">                .andExpect(status().isBadRequest());</span>
<span class="fc" id="L130">    }</span>

    @Test
    @WithMockUser
    public void testUpdate_ExistingId_ShouldReturnUpdatedSession() throws Exception {
<span class="fc" id="L135">        SessionDto updateSession = new SessionDto();</span>
<span class="fc" id="L136">        updateSession.setName(&quot;Updated Name&quot;);</span>
<span class="fc" id="L137">        updateSession.setDescription(&quot;Updated Description&quot;);</span>
<span class="fc" id="L138">        updateSession.setDate(session.getDate());</span>
<span class="pc bpc" id="L139" title="1 of 2 branches missed.">        if (session.getTeacher() != null) {</span>
<span class="nc" id="L140">            updateSession.setTeacher_id(session.getTeacher().getId());</span>
        } else {
<span class="fc" id="L142">            updateSession.setTeacher_id(1L);</span>
        }

<span class="fc" id="L145">        mockMvc.perform(put(&quot;/api/session/{id}&quot;, session.getId())</span>
<span class="fc" id="L146">                        .contentType(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L147">                        .content(objectMapper.writeValueAsString(updateSession)))</span>
<span class="fc" id="L148">                .andExpect(status().isOk())</span>
<span class="fc" id="L149">                .andExpect(jsonPath(&quot;$.name&quot;, is(&quot;Updated Name&quot;)))</span>
<span class="fc" id="L150">                .andExpect(jsonPath(&quot;$.description&quot;, is(&quot;Updated Description&quot;)));</span>
<span class="fc" id="L151">    }</span>

    @Test
    @WithMockUser
    public void testUpdate_InvalidId_ShouldReturn400() throws Exception {
<span class="fc" id="L156">        SessionDto updateSession = new SessionDto();</span>
<span class="fc" id="L157">        updateSession.setName(&quot;Updated Name&quot;);</span>
<span class="fc" id="L158">        updateSession.setDescription(&quot;Updated Description&quot;);</span>

<span class="fc" id="L160">        mockMvc.perform(put(&quot;/api/session/{id}&quot;, &quot;invalid&quot;)</span>
<span class="fc" id="L161">                        .contentType(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L162">                        .content(objectMapper.writeValueAsString(updateSession)))</span>
<span class="fc" id="L163">                .andExpect(status().isBadRequest());</span>
<span class="fc" id="L164">    }</span>

    @Test
    @WithMockUser
    public void testDelete_ExistingId_ShouldReturn200() throws Exception {
<span class="fc" id="L169">        mockMvc.perform(delete(&quot;/api/session/{id}&quot;, session.getId()))</span>
<span class="fc" id="L170">                .andExpect(status().isOk());</span>
<span class="fc" id="L171">    }</span>

    @Test
    @WithMockUser
    public void testDelete_NonExistingId_ShouldReturn404() throws Exception {
<span class="fc" id="L176">        mockMvc.perform(delete(&quot;/api/session/{id}&quot;, 999L))</span>
<span class="fc" id="L177">                .andExpect(status().isNotFound());</span>
<span class="fc" id="L178">    }</span>

    @Test
    @WithMockUser
    public void testDelete_InvalidId_ShouldReturn400() throws Exception {
<span class="fc" id="L183">        mockMvc.perform(delete(&quot;/api/session/{id}&quot;, &quot;invalid&quot;))</span>
<span class="fc" id="L184">                .andExpect(status().isBadRequest());</span>
<span class="fc" id="L185">    }</span>

    @Test
    @WithMockUser
    public void testParticipate_ValidIds_ShouldReturn200() throws Exception {
<span class="fc" id="L190">        User newUser = new User();</span>
<span class="fc" id="L191">        newUser.setFirstName(&quot;New&quot;);</span>
<span class="fc" id="L192">        newUser.setLastName(&quot;User&quot;);</span>
<span class="fc" id="L193">        newUser.setEmail(&quot;newuser@example.com&quot;);</span>
<span class="fc" id="L194">        newUser.setPassword(&quot;password&quot;);</span>
<span class="fc" id="L195">        newUser.setAdmin(false);</span>
<span class="fc" id="L196">        newUser = userRepository.save(newUser);</span>

<span class="fc" id="L198">        Session newSession = new Session();</span>
<span class="fc" id="L199">        newSession.setName(&quot;New Session&quot;);</span>
<span class="fc" id="L200">        newSession.setDescription(&quot;Description&quot;);</span>
<span class="fc" id="L201">        newSession.setDate(new Date());</span>
<span class="fc" id="L202">        newSession.setUsers(new ArrayList&lt;&gt;());</span>
<span class="fc" id="L203">        newSession = sessionRepository.save(newSession);</span>

<span class="fc" id="L205">        mockMvc.perform(post(&quot;/api/session/{id}/participate/{userId}&quot;, newSession.getId(), newUser.getId()))</span>
<span class="fc" id="L206">                .andExpect(status().isOk());</span>
<span class="fc" id="L207">    }</span>

    @Test
    @WithMockUser
    public void testParticipate_InvalidSessionId_ShouldReturn400() throws Exception {
<span class="fc" id="L212">        mockMvc.perform(post(&quot;/api/session/{id}/participate/{userId}&quot;, &quot;invalid&quot;, user.getId()))</span>
<span class="fc" id="L213">                .andExpect(status().isBadRequest());</span>
<span class="fc" id="L214">    }</span>

    @Test
    @WithMockUser
    public void testParticipate_InvalidUserId_ShouldReturn400() throws Exception {
<span class="fc" id="L219">        mockMvc.perform(post(&quot;/api/session/{id}/participate/{userId}&quot;, session.getId(), &quot;invalid&quot;))</span>
<span class="fc" id="L220">                .andExpect(status().isBadRequest());</span>
<span class="fc" id="L221">    }</span>

    @Test
    @WithMockUser
    public void testNoLongerParticipate_ValidIds_ShouldReturn200() throws Exception {
<span class="fc" id="L226">        mockMvc.perform(delete(&quot;/api/session/{id}/participate/{userId}&quot;, session.getId(), user.getId()))</span>
<span class="fc" id="L227">                .andExpect(status().isOk());</span>
<span class="fc" id="L228">    }</span>

    @Test
    @WithMockUser
    public void testNoLongerParticipate_InvalidSessionId_ShouldReturn400() throws Exception {
<span class="fc" id="L233">        mockMvc.perform(delete(&quot;/api/session/{id}/participate/{userId}&quot;, &quot;invalid&quot;, user.getId()))</span>
<span class="fc" id="L234">                .andExpect(status().isBadRequest());</span>
<span class="fc" id="L235">    }</span>

    @Test
    @WithMockUser
    public void testNoLongerParticipate_InvalidUserId_ShouldReturn400() throws Exception {
<span class="fc" id="L240">        mockMvc.perform(delete(&quot;/api/session/{id}/participate/{userId}&quot;, session.getId(), &quot;invalid&quot;))</span>
<span class="fc" id="L241">                .andExpect(status().isBadRequest());</span>
<span class="fc" id="L242">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>